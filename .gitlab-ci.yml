# To steruje CZY W OGLE utworzy pipeline
workflow:
  rules:
    # 1. Jeli to Merge Request -> ZAWSZE uruchom
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    
    # 2. Jeli to push na branch 'main' -> ZAWSZE uruchom
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    
    # 3. (Kluczowe) Jeli to zwyky push na branch, I JEST otwarty Merge Request...
    # ...to NIE uruchamiaj (bo regua nr 1 ju偶 to obsu偶ya).
    - if: $CI_OPEN_MERGE_REQUESTS
      when: never
    
    # 4. W ka偶dym innym przypadku (np. push na branch bez MR) -> Uruchom
    - when: always

stages:
  - test
  - deploy

.playwright-base:
  image: mcr.microsoft.com/playwright:v1.50.0-jammy
  rules:
    # Zawsze uruchom na g贸wnym branchu (Regression)
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
      
    # Na Merge Requestach uruchom TYLKO JELI dotkne kodu
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.ts"
        - "**/*.js"
        - "package.json"
        - "playwright.config.ts"
        - "docker-compose.yml"
        - ".gitlab-ci.yml"
      # Jeli zmienie tylko README.md, ten job si NIE utworzy!
  parallel: 3
  services:
    - name: postgres:latest
      alias: postgres-db 
      command: ["postgres", "-c", "fsync=off"]
  variables:
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: mysecretpassword
    DB_HOST: postgres-db
    DB_USER: postgres
    DB_PASSWORD: mysecretpassword
    BASE_URL: https://jsonplaceholder.typicode.com
    PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'
  cache:
    key: 
      files:
        - package-lock.json
    paths:
      - .npm/
  artifacts:
    when: always
    paths:
      - playwright-report/
    expire_in: 30 days
    reports:
      junit: test-results/results.xml

e2e-matrix:
  extends: .playwright-base
  stage: test
  
  #  DEFINICJA MACIERZY
  # To uruchomi job tyle razy, ile masz element贸w w licie
  parallel:
    matrix:
      - PROJECT: ['chromium', 'mobile-safari'] 
        # Upewnij si, 偶e te nazwy pasuj do 'name' w playwright.config.ts!
        # Jeli nie masz mobile-safari w configu, zmie na 'firefox' lub sam 'chromium'

  script:
    - npm ci --cache .npm --prefer-offline
    
    # 1. Uruchamiamy test dla konkretnego projektu z macierzy
    # U偶ywamy zmiennej $PROJECT, kt贸r podstawi GitLab
    - npx playwright test --project=$PROJECT
    
    # 2. Zmieniamy nazw folderu z raportem, 偶eby unikn konfliktu nazw
    # Np. mv playwright-report playwright-report-chromium
    - mv playwright-report playwright-report-$PROJECT

  # 3. Zbieramy artefakty z nowymi nazwami
  artifacts:
    when: always
    paths:
      - playwright-report-*/  # Gwiazdka apie wszystkie foldery!
    reports:
      junit: test-results/results.xml

pages:
  stage: deploy
  script:
    - mkdir public
    # Przenosimy WSZYSTKIE raporty do public
    # Stworzy to struktur: public/playwright-report-chromium/index.html
    - mv playwright-report-* public/
    
    # Opcjonalnie: Stw贸rz prosty index.html, 偶eby atwo klika w raporty
    - echo "<html><body><h1>Raporty Testowe</h1><ul>" > public/index.html
    - for d in public/*/; do echo "<li><a href='$(basename "$d")/index.html'>$(basename "$d")</a></li>" >> public/index.html; done
    - echo "</ul></body></html>" >> public/index.html
    
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == "main"