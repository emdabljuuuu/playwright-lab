# To steruje CZY W OGÓLE utworzyć pipeline
workflow:
  rules:
    # 1. Jeśli to Merge Request -> ZAWSZE uruchom
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    
    # 2. Jeśli to push na branch 'main' -> ZAWSZE uruchom
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    
    # 3. (Kluczowe) Jeśli to zwykły push na branch, I JEST otwarty Merge Request...
    # ...to NIE uruchamiaj (bo reguła nr 1 już to obsłużyła).
    - if: $CI_OPEN_MERGE_REQUESTS
      when: never
    
    # 4. W każdym innym przypadku (np. push na branch bez MR) -> Uruchom
    - when: always

stages:
  - test
  - deploy

.playwright-base:
  image: mcr.microsoft.com/playwright:v1.50.0-jammy
  rules:
    # Zawsze uruchom na głównym branchu (Regression)
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
      
    # Na Merge Requestach uruchom TYLKO JEŚLI dotknąłeś kodu
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.ts"
        - "**/*.js"
        - "package.json"
        - "playwright.config.ts"
        - "docker-compose.yml"
        - ".gitlab-ci.yml"
      # Jeśli zmieniłeś tylko README.md, ten job się NIE utworzy!
  parallel: 3
  services:
    - name: postgres:latest
      alias: postgres-db 
      command: ["postgres", "-c", "fsync=off"]
  variables:
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: mysecretpassword
    DB_HOST: postgres-db
    DB_USER: postgres
    DB_PASSWORD: mysecretpassword
    BASE_URL: https://jsonplaceholder.typicode.com
    PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'
  cache:
    key: 
      files:
        - package-lock.json
    paths:
      - .npm/
  artifacts:
    when: always
    paths:
      - playwright-report/
    expire_in: 30 days
    reports:
      junit: test-results/results.xml

# Testy Desktopowe
e2e-desktop:
  extends: .playwright-base
  stage: test
  script:
    - npm ci --cache .npm --prefer-offline
    # Upewnij się, że masz projekt 'chromium' w playwright.config.ts!
    - npx playwright test --project=chromium --shard=$CI_NODE_INDEX/$CI_NODE_TOTAL

# Testy Mobilne (Zakomentowane do czasu lekcji o łączeniu raportów)
# e2e-mobile:
#   extends: .playwright-base
#   stage: test
#   script:
#     - npm ci --cache .npm --prefer-offline
#     - npx playwright test --project=mobile-safari --shard=$CI_NODE_INDEX/$CI_NODE_TOTAL

pages:
  stage: deploy
  script:
    - mkdir public
    - mv playwright-report/* public/
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == "main"