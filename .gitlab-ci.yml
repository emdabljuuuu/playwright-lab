# 1. Definiujemy, w jakim obrazie domylnie uruchamiaj si skrypty
# U偶ywamy tego samego, co w Dockerfile!
image: mcr.microsoft.com/playwright:v1.50.0-jammy

# 2. Definiujemy etapy (Stages)
stages:
  - test

# 3. Definiujemy Joba "e2e-tests"
playwright-job:
  stage: test
  
  # 4. Serwisy poboczne (Baza Danych)
  services:
    - name: postgres:latest
      # WA呕NE: To jest nazwa hosta, pod kt贸r baza bdzie widoczna dla test贸w!
      alias: postgres-db 
      # Environment variables DLA BAZY (偶eby wiedziaa jak wsta)
      command: ["postgres", "-c", "fsync=off"] # Opcjonalna optymalizacja dla CI (szybciej, mniej bezpiecznie)

  # 5. Zmienne globalne (dostpne dla test贸w i serwis贸w)
  variables:
    # Konfiguracja Bazy (musi pasowa do tego co wy偶ej)
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: mysecretpassword
    
    # Konfiguracja Test贸w
    DB_HOST: postgres-db   # <-- Odwoujemy si do aliasu serwisu!
    DB_USER: postgres
    DB_PASSWORD: mysecretpassword
    BASE_URL: https://jsonplaceholder.typicode.com
    
    # Cache Playwrighta (偶eby nie instalowa przegldarek jeli s w obrazie)
    PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'

  # 6. Cache (przyspieszamy npm install)
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/

  # 7. Waciwe kroki
  script:
    - npm ci --cache .npm --prefer-offline
    - npx playwright test

  # 8. Raporty
  artifacts:
    when: always
    paths:
      - playwright-report/
      # - test-results/  <-- To mo偶emy usun z paths, bo bdzie w reports
    expire_in: 30 days
    
    #  MAGIA DZIEJE SI TUTAJ:
    reports:
      junit: test-results/results.xml